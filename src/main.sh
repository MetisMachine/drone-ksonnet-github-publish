#!/bin/bash

export GITHUB_TOKEN=${PLUGIN_GITHUB_TOKEN}

hub clone "${PLUGIN_GITHUB_ORG}/${PLUGIN_GITHUB_REPO}" repo

cd repo || exit

git checkout -b "${DRONE_BRANCH}/${PLUGIN_TAG}"

ks param set "${PLUGIN_KS_COMPONENT}" \
  "${PLUGIN_REPO}:${PLUGIN_TAG}" \
  --env "${PLUGIN_KS_ENV}"

git add environments/.

git commit -m "Drone auto-upgrade: ${PLUGIN_KS_COMPONENT} to ${PLUGIN_TAG}"

hub push origin "${DRONE_BRANCH}/${PLUGIN_TAG}"

hub pull-request \
  -m "${DRONE_REPO_NAME} ${PLUGIN_TAG}\n${PLUGIN_REPO}:${PLUGIN_TAG}\nGenerated by Drone"

